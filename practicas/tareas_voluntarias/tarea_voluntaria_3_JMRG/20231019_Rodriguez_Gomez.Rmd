---
title: "ACP Glaucoma_DB - Tarea Voluntaria 3"
author: "Juan Manuel Rodríguez Gómez"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  word_document:
    toc: yes
    toc_depth: '6'
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 6
    number_sections: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
---
<style>
.math {
  font-size: 8.25pt;options(encoding = 'UTF-8')
}
</style>

<div style="text-align: justify">

© This material is licensed under a **Creative Commons CC BY-NC-ND** attribution which allows *works to be downloaded and shared with others, as long as they are referenced, but may not be modified in any way or used commercially*.

In this work, we are going to apply a dimensionality reduction (PCA) to the dataset Glaucoma_DB.xlsx using the R language. Some changes had to be made to the data in the records so that the analysis could be performed correctly. For example, in a discrete quantitative variable, it appeared in a register "4 scattered", so it has been replaced simply by a 4.

# **Loading packages and data set**

## Loading and installing R packages

The following source code module is responsible for loading, if they are already installed, all the packages that will be used in this R session. While an R package can be loaded at any time when it is to be used, it is advisable to optimize its calls with this code chunk at the beginning.

Loading a package into an R session **requires it to be already installed**. If it is not, the first step is to run the sentence:

*install.packages("name_of_the_library")*


```{r warning=FALSE, message=FALSE}

#########################################
# Loading necessary packages and reason #
#########################################

# This is an example of the first installation of a package
# Only runs once if the package is not installed
# Once it is installed this sentence has to be commented (not to run again)
# install.packages("summarytools")

# Package required to call 'freq' and 'descr' functions (descriptive statistics)
library(summarytools)

# Package required to call 'ggplot' function (graphical tools)
library(ggplot2)

# Package required to call 'ggarrange' function (graphical tools)
library(ggpubr)

# Package required to call 'read.spss' function (loading '.spss' data format)
library(haven)

# Package required to call 'read_xlsx' function (loading '.xlsx' data format)
library(readxl)

# Package required to call 'cortest.bartlett' function
library(psych)

# Package required to call 'fviz_pca_var, fviz_pca_ind and fviz_pca' functions
library(factoextra)

# Package required to call 'scatterplot3d' function
library(scatterplot3d)

```

## Description of the data set *Glaucoma_DB.xlsx*


The following code chunk shows how to load the dataset with Excel format (.xlsx).

### Excel format *(xlsx)*

```{r warning=FALSE, message=FALSE}

# Loading a .xlsx (excel) file.
# The output of this function is already a data.frame object
# Remember that package 'readxl' is required
data_xlsx<-read_excel("Glaucoma_DB.xlsx", sheet = 2)

# This sentence identifies the type of object that the identifier represents
class(data_xlsx)

```

The file *Glaucoma_DB.xlsx* contains, among others, the variables *OJO, TIPO_GLAUCOMA, N_IMPACTOS, CUADRANTES, ENERGIA_IMPACTO, ENERGIA_TOTAL, CIRUJIA_PREVIA, PIO_PRE_SLT, PIO_1_SEMANA, PIO_1_MES, PIO_3_MES, FARMACOS_PRE, FARMACOS_1_MES, FARMACOS_3_MES, DOLOR, SEXO, EDAD, PIO_NORMAL, PIO_NORMAL_CAT*, which are not standardized. Each record in the dataset collects data from a glaucoma operation performed on a patient. Below is a description of each variable in the dataset:

+ Intervened eye (OJO)
+ Type of glaucoma/disease (TIPO_GLAUCOMA)
+ Number of impacts/Number of laser pulses (N_IMPACTOS)
+ Number of quadrants made (CUADRANTES)
+ Impact laser energy (ENERGIA_IMPACTO)
+ Sum of total impact energy (ENERGIA_TOTAL)
+ The patient has received any previous surgery (CIRUJIA_PREVIA)
+ Intraocular pressure before laser (PIO_PRE_SLT)
+ Intraocular pressure after a week of laser (PIO_1_SEMANA)
+ Intraocular pressure after one month of laser (PIO_1_MES)
+ Intraocular pressure after three months of laser (PIO_3_MES)
+ Number of medications before the intervention (FARMACOS_PRE)
+ Number of active medications after one month of laser (FARMACOS_1_MES)
+ Number of active medications after three months of laser (FARMACOS_3_MES)
+ The patient has experienced pain in the intervention (DOLOR)
+ Patient sex (SEXO)
+ Patient age (EDAD)
+ Pressure after intervention below 21 (PIO_NORMAL)
+ Positive/negative intervention result (PIO_NORMAL_CAT)

# **Basic descriptive statistics**

In this section, a preliminary exploratory data analysis of the data set is performed. For this purpose, if the variable is **quantitative**, the basic **numerical descriptive statistics** and a representation of its **histogram, density and boxplot** are shown. On the other hand, for the  **categorical** variables their **frequency table** and a **sector and bar diagram** are provided.

## **Exploring** the data set

```{r warning=FALSE, message=FALSE}

# This line loads the variable names from this data.frame
# So that we can access by their name with no refer to the data.frame identifier
attach(data_xlsx)

# Retrieving the name of all variables
colnames(data_xlsx)

# Displaying a few records
head(data_xlsx, n=10)

# Displaying basic descriptives of variable 'PIO_3_MES'
summary(PIO_3_MES)

# Displaying frequency table of variable 'TIPO_GLAUCOMA'
# Absolute
table(TIPO_GLAUCOMA)
# Relative
round(prop.table(table(TIPO_GLAUCOMA)),2)


```

## **Descriptive analysis** (numerical and graphical)


### Basic descriptive statistics of **quantitative variables**

#### N_IMPACTOS

```{r warning=FALSE, message=FALSE}

# Basic descriptive statistics
# Remember that package 'summarytools' is required
descr(N_IMPACTOS)

# Histogram, density and boxplot
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx,aes(x=N_IMPACTOS))+geom_density()+
  labs(title = "Density of N_IMPACTOS",x="N_IMPACTOS",y="Values")

p2<-ggplot(data_xlsx,aes(x=N_IMPACTOS))+geom_histogram()+
  labs(title = "Histogram of N_IMPACTOS",x="N_IMPACTOS",y="Values")

p3<-ggplot(data_xlsx,aes(x=N_IMPACTOS))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of N_IMPACTOS",x="Values",y="")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3, nrow=1, common.legend = FALSE)

```

#### CUADRANTES

```{r warning=FALSE, message=FALSE}

# Basic descriptive statistics
# Remember that package 'summarytools' is required
descr(CUADRANTES)

# Histogram, density and boxplot
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx,aes(x=CUADRANTES))+geom_density()+
  labs(title = "Density of CUADRANTES",x="CUADRANTES",y="Values")

p2<-ggplot(data_xlsx,aes(x=CUADRANTES))+geom_histogram()+
  labs(title = "Histogram of CUADRANTES",x="CUADRANTES",y="Values")

p3<-ggplot(data_xlsx,aes(x=CUADRANTES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of CUADRANTES",x="Values",y="")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3, nrow=1, common.legend = FALSE)

```

#### ENERGIA_IMPACTO

```{r warning=FALSE, message=FALSE}

# Basic descriptive statistics
# Remember that package 'summarytools' is required
descr(ENERGIA_IMPACTO)

# Histogram, density and boxplot
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx,aes(x=ENERGIA_IMPACTO))+geom_density()+
  labs(title = "Density of ENERGIA_IMPACTO",x="ENERGIA_IMPACTO",y="Values")

p2<-ggplot(data_xlsx,aes(x=ENERGIA_IMPACTO))+geom_histogram()+
  labs(title = "Histogram of ENERGIA_IMPACTO",x="ENERGIA_IMPACTO",y="Values")

p3<-ggplot(data_xlsx,aes(x=ENERGIA_IMPACTO))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of ENERGIA_IMPACTO",x="Values",y="")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3, nrow=1, common.legend = FALSE)

```

#### ENERGIA_TOTAL

```{r warning=FALSE, message=FALSE}

# Basic descriptive statistics
# Remember that package 'summarytools' is required
descr(ENERGIA_TOTAL)

# Histogram, density and boxplot
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx,aes(x=ENERGIA_TOTAL))+geom_density()+
  labs(title = "Density of ENERGIA_TOTAL",x="ENERGIA_TOTAL",y="Values")

p2<-ggplot(data_xlsx,aes(x=ENERGIA_TOTAL))+geom_histogram()+
  labs(title = "Histogram of ENERGIA_TOTAL",x="ENERGIA_TOTAL",y="Values")

p3<-ggplot(data_xlsx,aes(x=ENERGIA_TOTAL))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of ENERGIA_TOTAL",x="Values",y="")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3, nrow=1, common.legend = FALSE)

```

#### PIO_PRE_SLT

```{r warning=FALSE, message=FALSE}

# Basic descriptive statistics
# Remember that package 'summarytools' is required
descr(PIO_PRE_SLT)

# Histogram, density and boxplot
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx,aes(x=PIO_PRE_SLT))+geom_density()+
  labs(title = "Density of PIO_PRE_SLT",x="PIO_PRE_SLT",y="Values")

p2<-ggplot(data_xlsx,aes(x=PIO_PRE_SLT))+geom_histogram()+
  labs(title = "Histogram of PIO_PRE_SLT",x="PIO_PRE_SLT",y="Values")

p3<-ggplot(data_xlsx,aes(x=PIO_PRE_SLT))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_PRE_SLT",x="Values",y="")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3, nrow=1, common.legend = FALSE)

```

#### PIO_1_SEMANA

```{r warning=FALSE, message=FALSE}

# Basic descriptive statistics
# Remember that package 'summarytools' is required
descr(PIO_1_SEMANA)

# Histogram, density and boxplot
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx,aes(x=PIO_1_SEMANA))+geom_density()+
  labs(title = "Density of PIO_1_SEMANA",x="PIO_1_SEMANA",y="Values")

p2<-ggplot(data_xlsx,aes(x=PIO_1_SEMANA))+geom_histogram()+
  labs(title = "Histogram of PIO_1_SEMANA",x="PIO_1_SEMANA",y="Values")

p3<-ggplot(data_xlsx,aes(x=PIO_1_SEMANA))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_1_SEMANA",x="Values",y="")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3, nrow=1, common.legend = FALSE)

```

#### PIO_1_MES

```{r warning=FALSE, message=FALSE}

# Basic descriptive statistics
# Remember that package 'summarytools' is required
descr(PIO_1_MES)

# Histogram, density and boxplot
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx,aes(x=PIO_1_MES))+geom_density()+
  labs(title = "Density of PIO_1_MES",x="PIO_1_MES",y="Values")

p2<-ggplot(data_xlsx,aes(x=PIO_1_MES))+geom_histogram()+
  labs(title = "Histogram of PIO_1_MES",x="PIO_1_MES",y="Values")

p3<-ggplot(data_xlsx,aes(x=PIO_1_MES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_1_MES",x="Values",y="")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3, nrow=1, common.legend = FALSE)

```

#### PIO_3_MES

```{r warning=FALSE, message=FALSE}

# Basic descriptive statistics
# Remember that package 'summarytools' is required
descr(PIO_3_MES)

# Histogram, density and boxplot
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx,aes(x=PIO_3_MES))+geom_density()+
  labs(title = "Density of PIO_3_MES",x="PIO_3_MES",y="Values")

p2<-ggplot(data_xlsx,aes(x=PIO_3_MES))+geom_histogram()+
  labs(title = "Histogram of PIO_3_MES",x="PIO_3_MES",y="Values")

p3<-ggplot(data_xlsx,aes(x=PIO_3_MES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_3_MES",x="Values",y="")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3, nrow=1, common.legend = FALSE)

```

#### FARMACOS_PRE

```{r warning=FALSE, message=FALSE}

# Basic descriptive statistics
# Remember that package 'summarytools' is required
descr(FARMACOS_PRE)

# Histogram, density and boxplot
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx,aes(x=FARMACOS_PRE))+geom_density()+
  labs(title = "Density of FARMACOS_PRE",x="FARMACOS_PRE",y="Values")

p2<-ggplot(data_xlsx,aes(x=FARMACOS_PRE))+geom_histogram()+
  labs(title = "Histogram of FARMACOS_PRE",x="FARMACOS_PRE",y="Values")

p3<-ggplot(data_xlsx,aes(x=FARMACOS_PRE))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of FARMACOS_PRE",x="Values",y="")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3, nrow=1, common.legend = FALSE)

```

#### FARMACOS_1_MES

```{r warning=FALSE, message=FALSE}

# Basic descriptive statistics
# Remember that package 'summarytools' is required
descr(FARMACOS_1_MES)

# Histogram, density and boxplot
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx,aes(x=FARMACOS_1_MES))+geom_density()+
  labs(title = "Density of FARMACOS_1_MES",x="FARMACOS_1_MES",y="Values")

p2<-ggplot(data_xlsx,aes(x=FARMACOS_1_MES))+geom_histogram()+
  labs(title = "Histogram of FARMACOS_1_MES",x="FARMACOS_1_MES",y="Values")

p3<-ggplot(data_xlsx,aes(x=FARMACOS_1_MES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of FARMACOS_1_MES",x="Values",y="")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3, nrow=1, common.legend = FALSE)

```

#### FARMACOS_3_MES

```{r warning=FALSE, message=FALSE}

# Basic descriptive statistics
# Remember that package 'summarytools' is required
descr(FARMACOS_3_MES)

# Histogram, density and boxplot
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx,aes(x=FARMACOS_3_MES))+geom_density()+
  labs(title = "Density of FARMACOS_3_MES",x="FARMACOS_3_MES",y="Values")

p2<-ggplot(data_xlsx,aes(x=FARMACOS_3_MES))+geom_histogram()+
  labs(title = "Histogram of FARMACOS_3_MES",x="FARMACOS_3_MES",y="Values")

p3<-ggplot(data_xlsx,aes(x=FARMACOS_3_MES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of FARMACOS_3_MES",x="Values",y="")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3, nrow=1, common.legend = FALSE)

```

#### EDAD

```{r warning=FALSE, message=FALSE}

# Basic descriptive statistics
# Remember that package 'summarytools' is required
descr(EDAD)

# Histogram, density and boxplot
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx,aes(x=EDAD))+geom_density()+
  labs(title = "Density of EDAD",x="EDAD",y="Values")

p2<-ggplot(data_xlsx,aes(x=EDAD))+geom_histogram()+
  labs(title = "Histogram of EDAD",x="EDAD",y="Values")

p3<-ggplot(data_xlsx,aes(x=EDAD))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of EDAD",x="Values",y="")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3, nrow=1, common.legend = FALSE)

```

#### PIO_NORMAL

```{r warning=FALSE, message=FALSE}

# Basic descriptive statistics
# Remember that package 'summarytools' is required
descr(PIO_NORMAL)

# Histogram, density and boxplot
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx,aes(x=PIO_NORMAL))+geom_density()+
  labs(title = "Density of PIO_NORMAL",x="PIO_NORMAL",y="Values")

p2<-ggplot(data_xlsx,aes(x=PIO_NORMAL))+geom_histogram()+
  labs(title = "Histogram of PIO_NORMAL",x="PIO_NORMAL",y="Values")

p3<-ggplot(data_xlsx,aes(x=PIO_NORMAL))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_NORMAL",x="Values",y="")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3, nrow=1, common.legend = FALSE)

```

### Basic descriptive statistics of **categorical variables**

#### OJO

```{r warning=FALSE, message=FALSE}

# Frequency tables. Descriptive analysis
# Remember that package 'summarytools' is required
freq(as.factor(OJO))

# Pie chart and bar graph
p1<-ggplot(data_xlsx,aes(x=factor(1),fill=as.factor(OJO)))+geom_bar()+
  coord_polar("y")+labs(x="OJO",y="%")
p2<-ggplot(data_xlsx,aes(x=factor(1),fill=as.factor(OJO)))+geom_bar()+
  labs(x="OJO",y="%")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,nrow = 1,ncol=2, common.legend = TRUE)

```

#### TIPO_GLAUCOMA

```{r warning=FALSE, message=FALSE}

# Frequency tables. Descriptive analysis
# Remember that package 'summarytools' is required
freq(as.factor(TIPO_GLAUCOMA))

# Pie chart and bar graph
p1<-ggplot(data_xlsx,aes(x=factor(1),fill=as.factor(TIPO_GLAUCOMA)))+geom_bar()+
  coord_polar("y")+labs(x="TIPO_GLAUCOMA",y="%")
p2<-ggplot(data_xlsx,aes(x=factor(1),fill=as.factor(TIPO_GLAUCOMA)))+geom_bar()+
  labs(x="TIPO_GLAUCOMA",y="%")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,nrow = 1,ncol=2, common.legend = TRUE)

```

#### CIRUJIA_PREVIA

```{r warning=FALSE, message=FALSE}

# Frequency tables. Descriptive analysis
# Remember that package 'summarytools' is required
freq(as.factor(CIRUJIA_PREVIA))

# Pie chart and bar graph
p1<-ggplot(data_xlsx,aes(x=factor(1),fill=as.factor(CIRUJIA_PREVIA)))+geom_bar()+
  coord_polar("y")+labs(x="CIRUJIA_PREVIA",y="%")
p2<-ggplot(data_xlsx,aes(x=factor(1),fill=as.factor(CIRUJIA_PREVIA)))+geom_bar()+
  labs(x="CIRUJIA_PREVIA",y="%")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,nrow = 1,ncol=2, common.legend = TRUE)

```

#### DOLOR

```{r warning=FALSE, message=FALSE}

# Frequency tables. Descriptive analysis
# Remember that package 'summarytools' is required
freq(as.factor(DOLOR))

# Pie chart and bar graph
p1<-ggplot(data_xlsx,aes(x=factor(1),fill=as.factor(DOLOR)))+geom_bar()+
  coord_polar("y")+labs(x="DOLOR",y="%")
p2<-ggplot(data_xlsx,aes(x=factor(1),fill=as.factor(DOLOR)))+geom_bar()+
  labs(x="DOLOR",y="%")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,nrow = 1,ncol=2, common.legend = TRUE)

```

#### SEXO

```{r warning=FALSE, message=FALSE}

# Frequency tables. Descriptive analysis
# Remember that package 'summarytools' is required
freq(as.factor(SEXO))

# Pie chart and bar graph
p1<-ggplot(data_xlsx,aes(x=factor(1),fill=as.factor(SEXO)))+geom_bar()+
  coord_polar("y")+labs(x="SEXO",y="%")
p2<-ggplot(data_xlsx,aes(x=factor(1),fill=as.factor(SEXO)))+geom_bar()+
  labs(x="SEXO",y="%")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,nrow = 1,ncol=2, common.legend = TRUE)

```

#### PIO_NORMAL_CAT

```{r warning=FALSE, message=FALSE}

# Frequency tables. Descriptive analysis
# Remember that package 'summarytools' is required
freq(as.factor(PIO_NORMAL_CAT))

# Pie chart and bar graph
p1<-ggplot(data_xlsx,aes(x=factor(1),fill=as.factor(PIO_NORMAL_CAT)))+geom_bar()+
  coord_polar("y")+labs(x="PIO_NORMAL_CAT",y="%")
p2<-ggplot(data_xlsx,aes(x=factor(1),fill=as.factor(PIO_NORMAL_CAT)))+geom_bar()+
  labs(x="PIO_NORMAL_CAT",y="%")

# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,nrow = 1,ncol=2, common.legend = TRUE)

```

## **Not available data** (NA)

### Identification and treatment

**The decision for not available data is to replace them by the mean of their variable**. This decision has been made assuming that the behavior of the *NA* is totally random (this would have to be analyzed in depth to confirm this decision made).

The following source code defines the function *not_available* whose utility is to deal with not available data.


```{r warning=FALSE, message=FALSE}

# Construction of the function that handles missing values.
not_available<-function(data,na.rm=F){
  data[is.na(data)]<-mean(data,na.rm=T)
  data
}

# We call the not_available function for each variable in the database
data_xlsx$OJO<-not_available(data_xlsx$OJO)
data_xlsx$TIPO_GLAUCOMA<-not_available(data_xlsx$TIPO_GLAUCOMA)
data_xlsx$N_IMPACTOS<-not_available(data_xlsx$N_IMPACTOS)
data_xlsx$CUADRANTES<-not_available(data_xlsx$CUADRANTES)
data_xlsx$ENERGIA_IMPACTO<-not_available(data_xlsx$ENERGIA_IMPACTO)
data_xlsx$ENERGIA_TOTAL<-not_available(data_xlsx$ENERGIA_TOTAL)
data_xlsx$CIRUJIA_PREVIA<-not_available(data_xlsx$CIRUJIA_PREVIA)
data_xlsx$PIO_PRE_SLT<-not_available(data_xlsx$PIO_PRE_SLT)
data_xlsx$PIO_1_SEMANA<-not_available(data_xlsx$PIO_1_SEMANA)
data_xlsx$PIO_1_MES<-not_available(data_xlsx$PIO_1_MES)
data_xlsx$PIO_3_MES<-not_available(data_xlsx$PIO_3_MES)
data_xlsx$FARMACOS_PRE<-not_available(data_xlsx$FARMACOS_PRE)
data_xlsx$FARMACOS_1_MES<-not_available(data_xlsx$FARMACOS_1_MES)
data_xlsx$FARMACOS_3_MES<-not_available(data_xlsx$FARMACOS_3_MES)
data_xlsx$DOLOR<-not_available(data_xlsx$DOLOR)
data_xlsx$SEXO<-not_available(data_xlsx$SEXO)
data_xlsx$EDAD<-not_available(data_xlsx$EDAD)
data_xlsx$PIO_NORMAL<-not_available(data_xlsx$PIO_NORMAL)
data_xlsx$PIO_NORMAL_CAT<-not_available(data_xlsx$PIO_NORMAL_CAT)

# We view the data again
head(data_xlsx,n=3)

```

##  **Outliers**

### Identification 

This graphical output shows together the boxplots of all the quantitative variables. Since all the variables are standardized there is no problem with the scales.


```{r warning=FALSE, message=FALSE}

# Boxplots of all variables together
# This visualization is not the best due to the difference between the scales
boxplot(data_xlsx,main="Outliers",
        xlab="All explanatory variables",
        ylab="Values",
        col=c(1:15))

```

### Making decisions

From previous graphical outputs it is noticed the presence of outliers for several variables. It is relevant to take into account these values since multivariate methods, such as principal component analisis (PCA), are sensitive to this fact.

This is not a light topic and it should be analyzed outlier per outlier. However,  **the decision for outliers is to replace them by the mean of their variable**. 

The following source code defines the function *outlier* whose utility is to deal with the univariate outliers.


```{r warning=FALSE, message=FALSE}

# Recursive function that modifies outliers by the mean of their variable
outlier<-function(data,na.rm=T){

  H<-1.5*IQR(data)
  data[data<quantile(data,0.25,na.rm = T)-H]<-NA
  data[data>quantile(data,0.75, na.rm = T)+H]<-NA
  data[is.na(data)]<-mean(data, na.rm = T)
  H<-1.5*IQR(data)

  if (TRUE %in% (data<quantile(data,0.25,na.rm = T)-H) |
      TRUE %in% (data>quantile(data,0.75,na.rm = T)+H))
    outlier(data)
  else

    return(data)

}

# This data.frame is to preserve original data once the outliers are modified
data_xlsx_aux<-data_xlsx

# Called to outlier function for each variable identified with outliers
data_xlsx_aux$OJO<-outlier(data_xlsx_aux$OJO)
data_xlsx_aux$TIPO_GLAUCOMA<-outlier(data_xlsx_aux$TIPO_GLAUCOMA)
data_xlsx_aux$N_IMPACTOS<-outlier(data_xlsx_aux$N_IMPACTOS)
data_xlsx_aux$CUADRANTES<-outlier(data_xlsx_aux$CUADRANTES)
data_xlsx_aux$ENERGIA_IMPACTO<-outlier(data_xlsx_aux$ENERGIA_IMPACTO)
data_xlsx_aux$ENERGIA_TOTAL<-outlier(data_xlsx_aux$ENERGIA_TOTAL)
data_xlsx_aux$CIRUJIA_PREVIA<-outlier(data_xlsx_aux$CIRUJIA_PREVIA)
data_xlsx_aux$PIO_PRE_SLT<-outlier(data_xlsx_aux$PIO_PRE_SLT)
data_xlsx_aux$PIO_1_SEMANA<-outlier(data_xlsx_aux$PIO_1_SEMANA)
data_xlsx_aux$PIO_1_MES<-outlier(data_xlsx_aux$PIO_1_MES)
data_xlsx_aux$PIO_3_MES<-outlier(data_xlsx_aux$PIO_3_MES)
data_xlsx_aux$FARMACOS_PRE<-outlier(data_xlsx_aux$FARMACOS_PRE)
data_xlsx_aux$FARMACOS_1_MES<-outlier(data_xlsx_aux$FARMACOS_1_MES)
data_xlsx_aux$FARMACOS_3_MES<-outlier(data_xlsx_aux$FARMACOS_3_MES)
data_xlsx_aux$DOLOR<-outlier(data_xlsx_aux$DOLOR)
data_xlsx_aux$SEXO<-outlier(data_xlsx_aux$SEXO)
data_xlsx_aux$EDAD<-outlier(data_xlsx_aux$EDAD)
data_xlsx_aux$PIO_NORMAL<-outlier(data_xlsx_aux$PIO_NORMAL)
data_xlsx_aux$PIO_NORMAL_CAT<-outlier(data_xlsx_aux$PIO_NORMAL_CAT)

# We compare the original data and the fixed ones with respective boxplots 
par(mfrow=c(1,2))
# Boxplot original data
boxplot(data_xlsx,main="Original data",
        xlab="All explanatory variables",
        ylab="z-values",
        col=c(1:15))
# Boxplot fixed data
boxplot(data_xlsx_aux,main="Data with no outliers",
        xlab="All explanatory variables",
        ylab="z-values",
        col=c(1:15))


```

This is another joint visualization of the boxplots without the effect of the difference in scales.

With outliers:

```{r warning=FALSE, message=FALSE}

# Boxplots of all quantitative variables together
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx,aes(x=OJO))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of OJO",x="Values",y="")

p2<-ggplot(data_xlsx,aes(x=TIPO_GLAUCOMA))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of TIPO_GLAUCOMA",x="Values",y="")

p3<-ggplot(data_xlsx,aes(x=N_IMPACTOS))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of N_IMPACTOS",x="Values",y="")

p4<-ggplot(data_xlsx,aes(x=CUADRANTES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of CUADRANTES",x="Values",y="")

p5<-ggplot(data_xlsx,aes(x=ENERGIA_IMPACTO))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of ENERGIA_IMPACTO",x="Values",y="")

p6<-ggplot(data_xlsx,aes(x=ENERGIA_TOTAL))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of ENERGIA_TOTAL",x="Values",y="")

p7<-ggplot(data_xlsx,aes(x=CIRUJIA_PREVIA))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of CIRUJIA_PREVIA",x="Values",y="")

p8<-ggplot(data_xlsx,aes(x=PIO_PRE_SLT))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_PRE_SLT",x="Values",y="")

p9<-ggplot(data_xlsx,aes(x=PIO_1_SEMANA))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_1_SEMANA",x="Values",y="")

p10<-ggplot(data_xlsx,aes(x=PIO_1_MES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_1_MES",x="Values",y="")

p11<-ggplot(data_xlsx,aes(x=PIO_3_MES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_3_MES",x="Values",y="")

p12<-ggplot(data_xlsx,aes(x=FARMACOS_PRE))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of FARMACOS_PRE",x="Values",y="")

p13<-ggplot(data_xlsx,aes(x=FARMACOS_1_MES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of FARMACOS_1_MES",x="Values",y="")

p14<-ggplot(data_xlsx,aes(x=FARMACOS_3_MES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of FARMACOS_3_MES",x="Values",y="")

p15<-ggplot(data_xlsx,aes(x=DOLOR))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of DOLOR",x="Values",y="")

p16<-ggplot(data_xlsx,aes(x=SEXO))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of SEXO",x="Values",y="")

p17<-ggplot(data_xlsx,aes(x=EDAD))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of EDAD",x="Values",y="")

p18<-ggplot(data_xlsx,aes(x=PIO_NORMAL))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_NORMAL",x="Values",y="")

p19<-ggplot(data_xlsx,aes(x=PIO_NORMAL_CAT))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_NORMAL_CAT",x="Values",y="")
# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p17,p18,p19,
          nrow=3, ncol=4, 
          commond.legend=FALSE)
```

Without outliers:

```{r warning=FALSE, message=FALSE}

# Boxplots of all quantitative variables together
# Remember that package 'ggplot2' is required
p1<-ggplot(data_xlsx_aux,aes(x=OJO))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of OJO",x="Values",y="")

p2<-ggplot(data_xlsx_aux,aes(x=TIPO_GLAUCOMA))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of TIPO_GLAUCOMA",x="Values",y="")

p3<-ggplot(data_xlsx_aux,aes(x=N_IMPACTOS))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of N_IMPACTOS",x="Values",y="")

p4<-ggplot(data_xlsx_aux,aes(x=CUADRANTES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of CUADRANTES",x="Values",y="")

p5<-ggplot(data_xlsx_aux,aes(x=ENERGIA_IMPACTO))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of ENERGIA_IMPACTO",x="Values",y="")

p6<-ggplot(data_xlsx_aux,aes(x=ENERGIA_TOTAL))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of ENERGIA_TOTAL",x="Values",y="")

p7<-ggplot(data_xlsx_aux,aes(x=CIRUJIA_PREVIA))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of CIRUJIA_PREVIA",x="Values",y="")

p8<-ggplot(data_xlsx_aux,aes(x=PIO_PRE_SLT))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_PRE_SLT",x="Values",y="")

p9<-ggplot(data_xlsx_aux,aes(x=PIO_1_SEMANA))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_1_SEMANA",x="Values",y="")

p10<-ggplot(data_xlsx_aux,aes(x=PIO_1_MES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_1_MES",x="Values",y="")

p11<-ggplot(data_xlsx_aux,aes(x=PIO_3_MES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_3_MES",x="Values",y="")

p12<-ggplot(data_xlsx_aux,aes(x=FARMACOS_PRE))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of FARMACOS_PRE",x="Values",y="")

p13<-ggplot(data_xlsx_aux,aes(x=FARMACOS_1_MES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of FARMACOS_1_MES",x="Values",y="")

p14<-ggplot(data_xlsx_aux,aes(x=FARMACOS_3_MES))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of FARMACOS_3_MES",x="Values",y="")

p15<-ggplot(data_xlsx_aux,aes(x=DOLOR))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of DOLOR",x="Values",y="")

p16<-ggplot(data_xlsx_aux,aes(x=SEXO))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of SEXO",x="Values",y="")

p17<-ggplot(data_xlsx_aux,aes(x=EDAD))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of EDAD",x="Values",y="")

p18<-ggplot(data_xlsx_aux,aes(x=PIO_NORMAL))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_NORMAL",x="Values",y="")

p19<-ggplot(data_xlsx_aux,aes(x=PIO_NORMAL_CAT))+
  geom_boxplot(outlier.colour="red", outlier.shape=1,outlier.size=2)+
  coord_flip()+labs(title = "Boxplot of PIO_NORMAL_CAT",x="Values",y="")
# This function controls the graphical output device
# Remember that package 'ggpubr' is required
ggarrange(p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p17,p18,p19,
          nrow=3, ncol=4, 
          commond.legend=FALSE)
```

# **Principal component analysis**

## Requirements

### Correlated variables

If we display the correlation matrix, we will see that there are a couple of rows with the value 'NA':

```{r warning=FALSE, message=FALSE}

###############################
# Correlation at sample level #
###############################

# Are the variables correlated at sample level?
correlation_matrix<-cor(data_xlsx_aux)
correlation_matrix

```

It is observed that for the variables CUADRANTES and FARMACOS_3_MES, 'NA' is obtained. This is because all the records of these variables have the same value (in this case, this is due to the treatment of outliers), making their standard deviation equal to 0 and, therefore, we cannot calculate their correlation with other variables (since we would be dividing by 0, which is not possible). Therefore, we eliminate these two variables.

```{r warning=FALSE, message=FALSE}

# The variables 'CUADRANTES' is eliminated.
data_xlsx_aux <- data_xlsx_aux[, -c(4,14)]

# The first three records in the database are displayed
head(data_xlsx_aux,n=3)

```

According to the numerical results below, it is observed that the data **are correlated** both **at the sample level** (see correlation matrix) and **at the population level** (Bartlett's sphericity test is significant).

```{r warning=FALSE, message=FALSE}

###############################
# Correlation at sample level #
###############################

# Are the variables correlated at sample level?
correlation_matrix<-cor(data_xlsx_aux)
correlation_matrix
det(correlation_matrix)


###################################
# Correlation at population level #
###################################

# Bartlett's sphericity test:
# This test checks whether the correlations are significantly different from 0
# The null hypothesis is H_0; det(R)=1 means the variables are uncorrelated 
# R denotes the correlation matrix
# cortest.bartlett function in the package pysch performs this test
# This function works with standardized data.

# Standardization
data_pca_xlsx_scale<-scale(data_xlsx_aux)

# Bartlett's sphericity test
cortest.bartlett(cor(data_pca_xlsx_scale))

```

### Absence of outliers

Done in **Section 2.4.2** in the data.frame *data_xlsx_aux*.

### Standardized data

It is not necessary, since the *prcomp* function that obtains the principal components standardizes the data on its own.


## Principal components

### Obtaining


```{r warning=FALSE, message=FALSE}

# The 'prcomp' function in the base R package performs this analysis
# Parameters 'scale' and 'center' are set to TRUE to consider standardized data
PCA<-prcomp(data_xlsx_aux, scale = T, center = T)

# The field 'rotation' of the 'PCA' object is a matrix 
# Its columns are the coefficients of the principal components
# Indicates the weight of each variable in the corresponding principal component
PCA$rotation

# Standard deviations of each principal component
PCA$sdev
```


Each principal component is obtained in a simple way as a linear combination of all the variables with the coefficients indicated by the columns of the rotation matrix.


### Explained variance rate

```{r warning=FALSE, message=FALSE}

# The function 'summary' applied to the 'PCA' object provides relevant information
# - Standard deviations of each principal component
# - Proportion of variance explained and cummulative variance
summary(PCA)

# The following graph shows the proportion of explained variance
Explained_variance <- PCA$sdev^2 / sum(PCA$sdev^2)

p1<-ggplot(data = data.frame(Explained_variance, pc = 1:17),
  aes(x = pc, y = Explained_variance, fill=Explained_variance )) +
  geom_col(width = 0.3) + scale_y_continuous(limits = c(0,0.6)) + theme_bw() +
  labs(x = "Principal component", y= "Proportion of variance")

# The following graph shows the proportion of cumulative explained variance
Cummulative_variance<-cumsum(Explained_variance)

p2<-ggplot( data = data.frame(Cummulative_variance, pc = 1:17),
  aes(x = pc, y = Cummulative_variance ,fill=Cummulative_variance )) +
  geom_col(width = 0.5) +  scale_y_continuous(limits = c(0,1)) + theme_bw() +
  labs(x = "Principal component",
       y = "Proportion of cumulative variance")

p1
p2

```


### Appropriate number of principal components

There are different methods:

+ 1.- **Elbow method** (Cuadras, 2007).
+ 2.- **At the discretion of the researcher** who chooses a minimum percentage of variance explained by the principal components (it is not reliable because it can give more than necessary).
+ 3.- **Rule of Abdi et al.** (2010). The variances explained by the principal components are averaged and those whose proportion of explained variance exceeds the mean are selected.

For this illustration, applying the rule of Abdi et al., only **six principal components are considered**, as can be deduced from the following code chunk.

```{r warning=FALSE, message=FALSE}

#######################
# Rule of Abdi et al. #
#######################

# Variances
PCA$sdev^2

# Average of variances
mean(PCA$sdev^2)

```


### PCA graphical outputs of interest 

#### Distances 


```{r warning=FALSE, message=FALSE}

# These graphical outputs show the projection of the variables in two dimensions
# Display the weight of the variable in the direction of the principal component 
p1<-fviz_pca_var(PCA,repel=TRUE,col.var="cos2",
                 legend.title="Distance", title="Variables")+theme_bw()

p2<-fviz_pca_var(PCA,axes=c(1,3),repel=TRUE,col.var="cos2",
                 legend.title="Distance", title="Variables")+theme_bw()

p3<-fviz_pca_var(PCA,axes=c(2,3),repel=TRUE,col.var="cos2",
                 legend.title="Distance", title="Variables")+theme_bw()

# Displaying graphics
p1
p2
p3

```



#### Observations and variance contribution


```{r warning=FALSE, message=FALSE}

# It is also possible to represent the observations
# As well as identify with colors those observations that explain the greatest 
# variance of the principal components
p1<-fviz_pca_ind(PCA,col.ind = "contrib", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel=TRUE,legend.title="Contrib.var", title="Records")+theme_bw()

p2<-fviz_pca_ind(PCA,axes=c(1,3),col.ind = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel=TRUE,legend.title="Contrib.var", title="Records")+theme_bw()

p3<-fviz_pca_ind(PCA,axes=c(2,3),col.ind = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel=TRUE,legend.title="Contrib.var", title="Records")+theme_bw()

# Displaying graphics
p1
p2
p3

```



#### Observations and variables with variance contribution



```{r warning=FALSE, message=FALSE}

# Joint representation of variables and observations
# Relates the possible relationships between the contributions of the records
# to the variances of the components and the weight of the variables in each 
# principal component

p1<-fviz_pca(PCA,alpha.ind ="contrib", col.var = "cos2",
         col.ind="seagreen",
         gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"),
         repel=TRUE, legend.title="Distancia")+theme_bw()

p2<-fviz_pca(PCA,axes=c(1,3),alpha.ind ="contrib", 
         col.var = "cos2",col.ind="seagreen",
         gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"),
         repel=TRUE, legend.title="Distancia")+theme_bw()

p3<-fviz_pca(PCA,axes=c(2,3),alpha.ind ="contrib", 
         col.var = "cos2",col.ind="seagreen",
         gradient.cols = c("#FDF50E", "#FD960E", "#FD1E0E"),
         repel=TRUE, legend.title="Distancia")+theme_bw()

# Displaying graphics
p1
p2
p3

```


#### Coordinates in the new reference system


Finally, since the object of this study was to reduce the dimension of the data set, it is possible to obtain **the coordinates of the original data in the new reference system**. In fact, they are stored since we used the prcomp function to create the PCA variable.

```{r warning=FALSE, message=FALSE}

head(PCA$x)

```

